trigger:
- main

variables:
  buildConfiguration: 'Release'
  buildOutput: '$(Build.ArtifactStagingDirectory)/publish'
  azureSubscription: 'AzureServiceConnection'   # ← 你的 service connection 名
  webAppName: 'azure-demo-api-cragaha1'        # ← 你的 Web App 名

stages:
# =====================
# Stage 1: Build & Publish
# =====================
- stage: Build_and_Publish
  displayName: 'Build and Publish'
  jobs:
  - job: BuildJob
    displayName: 'Restore, Build, Publish'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    # 1) Checkout
    - checkout: self
      clean: true

    # 2) Install .NET 8 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'

    # 3) Restore
    - script: dotnet restore
      displayName: 'Restore packages'

    # 4) Build
    - script: dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'Build'

    # 5) （可选）Test —— 如果没有 *Tests 项目，这步会直接没东西测，但不会挂
    - script: dotnet test ./AzureDemoApi.Tests/AzureDemoApi.Tests.csproj -c $(buildConfiguration) --logger trx
      displayName: 'Test'
      continueOnError: true
    # 5.1) 发布测试结果到 Azure DevOps
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      condition: succeededOrFailed()  # 即便测试失败也要把结果发上来
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'
        searchFolder: '$(System.DefaultWorkingDirectory)'
        testRunTitle: 'Unit Tests'
        failTaskOnFailedTests: false   # 如果想让测试失败就让 pipeline 变红，可以先设 true
    # 5.2) 发布代码覆盖率（基于 XPlat Code Coverage 的 Cobertura 报告）
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Code Coverage'
      condition: succeededOrFailed()
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.cobertura.xml'
        reportDirectory: '$(System.DefaultWorkingDirectory)'
        failIfCoverageEmpty: false
    # 6) Publish
    - script: dotnet publish ./AzureDemoApi.csproj -c $(buildConfiguration) -o $(buildOutput)
      displayName: 'Publish (Web API only)'

    # 7) 发布构建产物（Artifacts）
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

# =====================
# Stage 2: Deploy to Azure Web App (with Environment)
# =====================
- stage: Deploy_Dev
  displayName: 'Deploy to Azure Web App'
  dependsOn: Build_and_Publish
  condition: succeeded()      # 只有上一个 stage 成功才执行部署

  jobs:
  - deployment: DeployJob                         # ← deployment 类型的 job
    displayName: 'Deploy to azure-demo-api-cragaha1'
    environment: 'dev'                            # ← 这里关联 Environment（可加审批）
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none          # 部署只用构建产物，不需要重新拉代码

          # 1) 下载上一个 Stage 的 Artifact
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'

          # 2) 部署到 Azure Web App（沿用你的 connection 和 appName）
          - task: AzureWebApp@1
            displayName: 'Deploy to STAGING slot'
            inputs:
              azureSubscription: '$(azureSubscription)'         # AzureServiceConnection
              appName: '$(webAppName)'                          # azure-demo-api-cragaha1
              appType: 'webAppLinux'
              slotName: 'staging'
              package: '$(System.ArtifactsDirectory)/drop/publish'
                        # ⭐ Step A5：冒烟测试（紧跟在 deploy 后）
          - script: |
              set -e
              echo "Running smoke test on STAGING..."
              curl -f https://azure-demo-api-cragaha1-staging-a8c2c0hjajd0htda.canadacentral-01.azurewebsites.net/health
            displayName: 'Smoke test /health on STAGING'
