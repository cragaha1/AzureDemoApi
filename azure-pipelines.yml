trigger:
- main

variables:
  buildConfiguration: 'Release'
  buildOutput: '$(Build.ArtifactStagingDirectory)/publish'
  azureSubscription: 'AzureServiceConnection'   # ← 你的 service connection 名
  webAppName: 'azure-demo-api-cragaha1'        # ← 你的 Web App 名

stages:
# =====================
# Stage 1: Build & Publish
# =====================
- stage: Build_and_Publish
  displayName: 'Build and Publish'
  jobs:
  - job: BuildJob
    displayName: 'Restore, Build, Publish'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    # 1) Checkout
    - checkout: self
      clean: true

    # 2) Install .NET 8 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'

    # 3) Restore
    - script: dotnet restore
      displayName: 'Restore packages'

    # 4) Build
    - script: dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'Build'

    # 5) （可选）Test —— 如果没有 *Tests 项目，这步会直接没东西测，但不会挂
    - script: dotnet test --configuration $(buildConfiguration)
      displayName: 'Test'
      continueOnError: true

    # 6) Publish
    - script: dotnet publish --configuration $(buildConfiguration) --output $(buildOutput)
      displayName: 'Publish'

    # 7) 发布构建产物（Artifacts）
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

# =====================
# Stage 2: Deploy to Azure Web App (with Environment)
# =====================
- stage: Deploy_Dev
  displayName: 'Deploy to Azure Web App'
  dependsOn: Build_and_Publish
  condition: succeeded()      # 只有上一个 stage 成功才执行部署

  jobs:
  - deployment: DeployJob                         # ← deployment 类型的 job
    displayName: 'Deploy to azure-demo-api-cragaha1'
    environment: 'dev'                            # ← 这里关联 Environment（可加审批）
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: none          # 部署只用构建产物，不需要重新拉代码

          # 1) 下载上一个 Stage 的 Artifact
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'

          # 2) 部署到 Azure Web App（沿用你的 connection 和 appName）
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '$(azureSubscription)'         # AzureServiceConnection
              appName: '$(webAppName)'                          # azure-demo-api-cragaha1
              appType: 'webAppLinux'
              package: '$(System.ArtifactsDirectory)/drop/publish'
